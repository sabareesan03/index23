<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Cricket Score Keeper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a7a7238209.js" crossorigin="anonymous"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            color: #f3f4f6;
        }
        .container-card {
            background-color: #374151;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        .action-button {
            transition: all 0.2s;
        }
        #messageBox {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s;
        }
        #messageBox.show {
            visibility: visible;
            opacity: 1;
        }
        .utility-btn {
             transition: all 0.2s;
             background-color: #4f46e5;
             color: white;
        }
        .utility-btn:hover {
             background-color: #4338ca;
        }
        .scorecard-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .scorecard-table th, .scorecard-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #4b5563;
        }
        .scorecard-table th {
            background-color: #1f2937;
            color: #9ca3af;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        .scorecard-table tr:last-child td {
            border-bottom: none;
        }
        .scorecard-table td:nth-child(2), 
        .scorecard-table td:nth-child(3), 
        .scorecard-table td:nth-child(4),
        .scorecard-table td:nth-child(5),
        .scorecard-table td:nth-child(6) {
            text-align: center;
        }
        .player-key-input {
            font-family: monospace;
            font-size: 0.875rem;
        }
        .optional-key {
            border: 1px dashed #6b7280;
        }
    </style>
    <!-- Firebase setup imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cricket-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            setLogLevel('Debug');
        } else {
             console.warn("Firebase configuration is missing or empty. Running in local-only mode.");
             window.db = null;
             window.auth = null;
        }

        // Player Profile Management Functions
        window.getPlayerProfileRef = function(playerKey) {
            if (!window.db) return null;
            return doc(window.db, `player_profiles/${playerKey}`);
        };

        window.updatePlayerStats = async function(playerKey, matchStats) {
            if (!window.db || !playerKey) return;
            
            const playerRef = window.getPlayerProfileRef(playerKey);
            
            try {
                await runTransaction(window.db, async (transaction) => {
                    const playerDoc = await transaction.get(playerRef);
                    
                    if (!playerDoc.exists()) {
                        // Create new player profile
                        const newProfile = {
                            name: matchStats.name,
                            playerKey: playerKey,
                            matchesPlayed: 1,
                            totalRuns: matchStats.runs || 0,
                            highestScore: matchStats.runs || 0,
                            totalBallsFaced: matchStats.balls || 0,
                            totalWickets: matchStats.wickets || 0,
                            bestBowlingRuns: matchStats.runsGiven || 0,
                            bestBowlingWickets: matchStats.wicketsTaken || 0,
                            totalOversBowled: matchStats.overs || 0,
                            totalRunsConceded: matchStats.runsGiven || 0,
                            lastUpdated: new Date().toISOString(),
                            createdAt: new Date().toISOString()
                        };
                        transaction.set(playerRef, newProfile);
                    } else {
                        // Update existing player profile
                        const existingData = playerDoc.data();
                        const updatedProfile = {
                            ...existingData,
                            matchesPlayed: existingData.matchesPlayed + 1,
                            totalRuns: existingData.totalRuns + (matchStats.runs || 0),
                            highestScore: Math.max(existingData.highestScore, matchStats.runs || 0),
                            totalBallsFaced: existingData.totalBallsFaced + (matchStats.balls || 0),
                            totalWickets: existingData.totalWickets + (matchStats.wickets || 0),
                            totalRunsConceded: existingData.totalRunsConceded + (matchStats.runsGiven || 0),
                            totalOversBowled: existingData.totalOversBowled + (matchStats.overs || 0),
                            lastUpdated: new Date().toISOString()
                        };
                        
                        // Update best bowling figures if current match is better
                        if (matchStats.wicketsTaken > 0) {
                            if (this.isBetterBowlingFigure(matchStats.wicketsTaken, matchStats.runsGiven, existingData.bestBowlingWickets, existingData.bestBowlingRuns)) {
                                updatedProfile.bestBowlingWickets = matchStats.wicketsTaken;
                                updatedProfile.bestBowlingRuns = matchStats.runsGiven;
                            }
                        }
                        
                        transaction.set(playerRef, updatedProfile);
                    }
                });
                console.log(`Player stats updated for key: ${playerKey}`);
            } catch (error) {
                console.error("Error updating player stats:", error);
            }
        };

        window.isBetterBowlingFigure = function(currentWickets, currentRuns, bestWickets, bestRuns) {
            if (currentWickets > bestWickets) return true;
            if (currentWickets === bestWickets && currentRuns < bestRuns) return true;
            return false;
        };

        window.getPlayerStats = async function(playerKey) {
            if (!window.db || !playerKey) return null;
            
            try {
                const playerRef = window.getPlayerProfileRef(playerKey);
                const playerDoc = await getDoc(playerRef);
                
                if (playerDoc.exists()) {
                    return playerDoc.data();
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Error fetching player stats:", error);
                return null;
            }
        };

        async function initAuthAndFirestore() {
            if (!window.auth) {
                 window.currentUser = { uid: crypto.randomUUID() };
                 document.getElementById('userIdDisplay').textContent = window.currentUser.uid + " (Local Mode)";
                 window.gameState = initializeGameState(true);
                 renderGame();
                 return;
            }

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Firebase Auth error:", error);
            }

            onAuthStateChanged(window.auth, (user) => {
                const userId = user?.uid || crypto.randomUUID();
                window.currentUser = { uid: userId };
                document.getElementById('userIdDisplay').textContent = userId;
                console.log("Auth state changed. User ID:", userId);

                if (window.db) {
                    setupFirestoreListener(userId);
                }
            });
        }

        function getDocRef(userId) {
            const docPath = `/artifacts/${appId}/users/${userId}/gameData/currentMatch`;
            return doc(window.db, docPath);
        }

        function setupFirestoreListener(userId) {
            const docRef = getDocRef(userId);
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const loadedState = data.gameState ? JSON.parse(data.gameState) : initializeGameState(false);
                    window.gameState = loadedState;
                    console.log("Loaded state from Firestore:", window.gameState);
                } else {
                    console.log("No game data found in Firestore. Initializing new game.");
                    window.gameState = initializeGameState(false);
                    saveGame(userId);
                }
                renderGame();
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                showMessage('Error loading game data.', 'error');
            });
        }

        window.saveGame = async function(userId) {
            if (!window.db || !window.gameState || !userId) return;
            const docRef = getDocRef(userId);
            
            try {
                await setDoc(docRef, { 
                    gameState: JSON.stringify(window.gameState),
                    lastUpdated: new Date().toISOString(),
                    userId: userId
                });
                console.log("Game state saved to Firestore.");
            } catch (e) {
                console.error("Error writing document to Firestore:", e);
                showMessage('Error saving game data.', 'error');
            }
        };
        
        window.initAuthAndFirestore = initAuthAndFirestore;
    </script>
</head>
<body>

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-indigo-400">Advanced Cricket Score Keeper</h1>
            <p id="userIdDisplay" class="text-sm text-gray-400 mt-1"></p>
        </header>

        <!-- Message Box -->
        <div id="messageBox" class="fixed top-4 left-1/2 -translate-x-1/2 p-4 rounded-lg z-50 text-center shadow-2xl min-w-[300px]">
            <span id="messageText" class="font-semibold"></span>
        </div>

        <!-- Start/Setup Button -->
        <div id="start-button-container" class="mb-6">
            <button onclick="showModal('setup-modal')" class="w-full p-4 bg-green-600 hover:bg-green-700 rounded-xl font-extrabold text-xl shadow-lg">
                Start / Reset Match Setup
            </button>
        </div>

        <!-- NEW: Player Stats Button -->
        <div class="mb-6 text-center">
            <button onclick="showModal('player-stats-modal')" class="p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold text-white shadow-md">
                <i class="fas fa-chart-line mr-2"></i>View Player Stats
            </button>
        </div>

        <!-- Scoreboard Card (Game View) -->
        <div id="game-view" class="hidden">
            <div class="container-card p-6 md:p-8 rounded-xl mb-6">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">
                    <span id="battingTeamName">Team A</span> Batting (Target: <span id="targetDisplay">0</span>)
                </h2>

                <!-- Current Score -->
                <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-4">
                    <div class="text-4xl font-bold">
                        <span id="totalRuns">0</span>/<span id="totalWickets">0</span>
                    </div>
                    <div class="text-lg font-medium text-gray-300">
                        Overs: <span id="currentOvers">0.0</span>
                    </div>
                </div>
                
                <!-- Current Over Log -->
                <div class="mb-6 p-3 bg-gray-700 rounded-lg">
                    <p class="text-sm font-medium text-gray-400 mb-1">Current Over Log:</p>
                    <p id="over-log-display" class="text-2xl font-mono text-yellow-300 font-bold tracking-widest min-h-8">--</p>
                </div>
                
                <!-- Batsmen and Bowler Info -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-3 bg-gray-700 rounded-lg md:col-span-2 grid grid-cols-2 gap-3">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Batsman on Strike:</p>
                            <p id="strikeBatsman" class="text-lg font-semibold">N/A</p>
                            <p class="text-sm text-gray-400">Runs: <span id="strikeRuns">0</span> | Balls: <span id="strikeBalls">0</span></p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-400">Non-Striker:</p>
                            <p id="nonStrikeBatsman" class="text-lg font-semibold">N/A</p>
                            <p class="text-sm text-gray-400">Runs: <span id="nonStrikeRuns">0</span> | Balls: <span id="nonStrikeBalls">0</span></p>
                        </div>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm font-medium text-gray-400">Bowler:</p>
                        <p id="currentBowler" class="text-lg font-semibold">N/A</p>
                        <p class="text-sm text-gray-400">Figures: <span id="bowlerRuns">0</span>/<span id="bowlerWickets">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Ball Action Controls -->
            <div class="container-card p-6 md:p-8 rounded-xl mb-6">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">Ball Actions</h2>
                <div class="grid grid-cols-3 sm:grid-cols-5 gap-4">
                    
                    <!-- Run Buttons -->
                    <button onclick="handleRunAction(0, 'Dot Ball')" class="action-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        Dot (0)
                    </button>
                    <button onclick="handleRunAction(1, 'Single Run')" class="action-button bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        1 Run
                    </button>
                    <button onclick="handleRunAction(2, 'Two Runs')" class="action-button bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        2 Runs
                    </button>
                    <button onclick="handleRunAction(4, 'Boundary')" class="action-button bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        4 Runs
                    </button>
                    <button onclick="handleRunAction(6, 'Six')" class="action-button bg-green-700 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        6 Runs
                    </button>

                    <!-- Extra/Wicket Buttons -->
                    <button onclick="handleExtraAction('Wide', 1)" class="action-button bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        Wide (WD)
                    </button>
                    <button onclick="handleExtraAction('No-Ball', 1)" class="action-button bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        No-Ball (NB)
                    </button>
                    <button onclick="handleExtraAction('Leg-Bye', promptRuns())" class="action-button bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        Leg-Bye (LB)
                    </button>
                    <button onclick="handleExtraAction('Bye', promptRuns())" class="action-button bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        Bye (B)
                    </button>
                    <button onclick="prepareWicketModal()" class="action-button bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-xl">
                        Wicket <span class="text-xs font-normal">(W)</span>
                    </button>
                    
                </div>
            </div>

            <!-- Utility Controls (New Bowler, Scorecard) -->
            <div class="container-card p-6 md:p-8 rounded-xl mb-6">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">Game Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Select New Bowler -->
                    <div id="newBowlerContainer" class="bg-gray-700 p-4 rounded-lg hidden">
                        <p class="text-yellow-300 font-semibold mb-2">OVER COMPLETED! Select New Bowler:</p>
                        <label for="bowlerSelect" class="block text-sm font-medium text-gray-400 mb-2">Select New Bowler (Non-WK):</label>
                        <select id="bowlerSelect" class="w-full bg-gray-800 text-white p-2 rounded-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Options will be populated here -->
                        </select>
                        <button onclick="startNewOver()" class="mt-3 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg shadow-md">
                            Start Over
                        </button>
                    </div>

                    <!-- Utility Buttons -->
                    <div class="p-4 rounded-lg grid grid-cols-2 gap-4">
                        <button onclick="swapStrike()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg shadow-md">
                            Swap Strike
                        </button>
                         <button id="view-scorecard-btn" onclick="showScorecard()" class="w-full utility-btn font-bold py-3 rounded-lg shadow-md">
                            View Scorecard
                        </button>
                        <button id="start-new-innings-btn" onclick="startNewInnings()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 rounded-lg shadow-md hidden col-span-2">
                            Start Second Innings
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Match Completion Section -->
            <div class="container-card p-6 md:p-8 rounded-xl mb-6">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">Match Completion</h2>
                <div class="p-4 rounded-lg">
                    <button id="new-match-btn" onclick="startNewMatch()" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md hidden">
                        Start New Match
                    </button>
                </div>
            </div>
        </div>

        <!-- Modals -->

        <!-- 1. Match Setup Modal -->
        <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h2 class="text-2xl font-bold text-indigo-300 mb-4">1. Match Rules Setup</h2>
                <div class="mb-4">
                    <label for="total-overs" class="block text-sm font-medium text-gray-400 mb-1">Total Overs:</label>
                    <input type="number" id="total-overs" value="20" min="1" class="w-full p-3 mb-3 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:ring-green-500 focus:border-green-500 border-transparent">
                </div>
                <div class="mb-4">
                    <label for="players-per-team" class="block text-sm font-medium text-gray-400 mb-1">Players Per Team (Min 2):</label>
                    <input type="number" id="players-per-team" value="11" min="2" max="11" class="w-full p-3 mb-3 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:ring-green-500 focus:border-green-500 border-transparent">
                </div>
                <button onclick="setupRosters()" class="w-full mt-2 p-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-bold">
                    Set Rules & Define Rosters
                </button>
                <button onclick="hideModal('setup-modal')" class="w-full mt-3 p-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold">
                    Cancel
                </button>
            </div>
        </div>

        <!-- 2. Roster Setup Modal -->
        <div id="roster-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-2xl my-8">
                <h2 class="text-2xl font-bold text-indigo-300 mb-4">2. Define Team Rosters</h2>
                
                <!-- NEW: Player Key Setup Section -->
                <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3 text-yellow-300">Player Key Assignment (Optional)</h3>
                    <p class="text-sm text-gray-400 mb-4">Assign unique player keys to track career statistics. Leave blank for normal players.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Striker Key (Optional):</label>
                            <input type="text" id="striker-key" placeholder="Leave blank for normal player" class="w-full p-2 bg-gray-800 rounded-lg text-white player-key-input optional-key">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Non-Striker Key (Optional):</label>
                            <input type="text" id="non-striker-key" placeholder="Leave blank for normal player" class="w-full p-2 bg-gray-800 rounded-lg text-white player-key-input optional-key">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Bowler Key (Optional):</label>
                        <input type="text" id="bowler-key" placeholder="Leave blank for normal player" class="w-full p-2 bg-gray-800 rounded-lg text-white player-key-input optional-key">
                    </div>
                    <button onclick="generateRandomKeys()" class="w-full p-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white mb-2">
                        Generate Random Keys
                    </button>
                    <p class="text-xs text-gray-500">Note: Only players with keys will have career statistics tracked.</p>
                </div>
                
                <div class="space-y-6" id="roster-forms">
                    <!-- Roster forms will be injected here -->
                </div>
                <button onclick="setupTossAndStartModal()" class="w-full mt-6 p-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                    Confirm Rosters & Proceed to Toss
                </button>
                <button onclick="hideModal('roster-modal')" class="w-full mt-3 p-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold">
                    Back to Rules
                </button>
            </div>
        </div>

        <!-- 3. Toss and Start Modal -->
        <div id="toss-start-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h2 class="text-2xl font-bold text-indigo-300 mb-4">3. Toss & Starting XI</h2>
                
                <!-- Toss Selection -->
                <div id="toss-selection-area" class="mb-6 p-4 border border-gray-600 rounded-lg">
                    <h3 class="text-xl font-semibold mb-2 text-gray-300">Toss Selection</h3>
                    <div class="mb-3">
                        <label for="toss-winner" class="block text-sm font-medium text-gray-400 mb-1">Toss Winner:</label>
                        <select id="toss-winner" class="w-full p-3 bg-gray-700 rounded-lg text-white focus:ring-green-500 focus:border-green-500 border-transparent">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="toss-choice" class="block text-sm font-medium text-gray-400 mb-1">Choice:</label>
                        <select id="toss-choice" class="w-full p-3 bg-gray-700 rounded-lg text-white focus:ring-green-500 focus:border-green-500 border-transparent">
                            <option value="bat">Bat</option>
                            <option value="bowl">Bowl</option>
                        </select>
                    </div>
                    <button onclick="confirmTossAndShowStartingXI()" class="w-full mt-4 p-3 bg-indigo-500 hover:bg-indigo-600 rounded-lg font-bold">
                        Confirm Toss & Select Starting XI
                    </button>
                </div>
                
                <!-- Starting XI Selection -->
                <div id="starting-xi-area" class="mb-6 p-4 border border-gray-600 rounded-lg hidden">
                     <h3 class="text-xl font-semibold mb-3 text-gray-300">Starting XI (Batting Team: <span id="batting-team-name-xi"></span>)</h3>
                    <div class="space-y-3">
                        <!-- Striker -->
                        <div>
                            <label for="start-striker" class="block text-sm font-medium text-gray-400 mb-1">Striker (S):</label>
                            <select id="start-striker" class="w-full p-3 bg-gray-700 rounded-lg text-white"></select>
                        </div>
                        <!-- Non-Striker -->
                        <div>
                            <label for="start-non-striker" class="block text-sm font-medium text-gray-400 mb-1">Non-Striker (NS):</label>
                            <select id="start-non-striker" class="w-full p-3 bg-gray-700 rounded-lg text-white"></select>
                        </div>
                        <!-- Bowler -->
                        <div>
                            <label for="start-bowler" class="block text-sm font-medium text-gray-400 mb-1">First Bowler:</label>
                            <select id="start-bowler" class="w-full p-3 bg-gray-700 rounded-lg text-white"></select>
                        </div>
                    </div>

                    <button onclick="startMatch()" class="w-full mt-4 p-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                        START MATCH
                    </button>
                </div>
                
                <button onclick="hideModal('toss-start-modal')" class="w-full mt-3 p-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold">
                    Back
                </button>
            </div>
        </div>

        <!-- 4. Scorecard Modal -->
        <div id="scorecard-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-4xl my-8">
                <h2 class="text-2xl font-bold text-indigo-300 mb-4">Full Match Scorecard</h2>
                <div id="scorecard-content" class="text-white space-y-6">
                    <!-- Scorecard content will be dynamically generated here -->
                </div>
                <button onclick="hideModal('scorecard-modal')" class="w-full mt-6 p-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold">
                    Close Scorecard
                </button>
            </div>
        </div>
        
        <!-- 5. Wicket Modal - FIXED: Added next batsman selection -->
        <div id="wicket-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md">
                <h2 class="text-2xl font-bold text-red-400 mb-4">WICKET FALLS!</h2>
                
                <div class="mb-4">
                    <p class="text-lg font-semibold text-gray-300 mb-2">Batsman Out: <span id="batsman-out-name">N/A</span></p>
                    <label for="dismissal-type" class="block text-sm font-medium text-gray-400 mb-1">Dismissal Type:</label>
                    <select id="dismissal-type" onchange="toggleFielder(this.value)" class="w-full p-3 bg-gray-700 rounded-lg text-white focus:ring-red-500 focus:border-red-500 border-transparent">
                        <option value="Caught">Caught</option>
                        <option value="Bowled">Bowled</option>
                        <option value="LBW">LBW (Leg Before Wicket)</option>
                        <option value="Run Out">Run Out</option>
                        <option value="Stumped">Stumped</option>
                        <option value="Hit Wicket">Hit Wicket</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div id="fielder-group" class="mb-4">
                    <label for="fielder-select" class="block text-sm font-medium text-gray-400 mb-1">Fielder / Keeper:</label>
                    <select id="fielder-select" class="w-full p-3 bg-gray-700 rounded-lg text-white focus:ring-red-500 focus:border-red-500 border-transparent">
                        <!-- Options populated by JS -->
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Required for Caught, Run Out, Stumped.</p>
                </div>

                <!-- FIXED: Added next batsman selection -->
                <div id="next-batsman-group" class="mb-4">
                    <label for="next-batsman-select" class="block text-sm font-medium text-gray-400 mb-1">Next Batsman:</label>
                    <select id="next-batsman-select" class="w-full p-3 bg-gray-700 rounded-lg text-white focus:ring-green-500 focus:border-green-500 border-transparent">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                
                <p class="text-sm text-gray-400 mb-4">Bowler credited: <span id="wicket-bowler-name" class="font-semibold text-white">N/A</span></p>

                <button onclick="handleWicketActionFromModal()" class="w-full mt-2 p-3 bg-red-600 hover:bg-red-700 rounded-lg font-bold">
                    Confirm Wicket
                </button>
                <button onclick="hideModal('wicket-modal')" class="w-full mt-3 p-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold">
                    Cancel
                </button>
            </div>
        </div>

        <!-- NEW: Player Stats Modal -->
        <div id="player-stats-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-2xl">
                <h2 class="text-2xl font-bold text-indigo-300 mb-4">Player Career Statistics</h2>
                
                <div class="mb-6">
                    <label for="player-key-input" class="block text-sm font-medium text-gray-400 mb-2">Enter Player Key:</label>
                    <div class="flex space-x-2">
                        <input type="text" id="player-key-input" placeholder="e.g., PLAYER001" class="flex-grow p-3 bg-gray-700 rounded-lg text-white player-key-input focus:ring-purple-500 focus:border-purple-500">
                        <button onclick="loadPlayerStats()" class="px-6 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold text-white">
                            Load Stats
                        </button>
                    </div>
                </div>

                <div id="player-stats-content" class="bg-gray-700 p-4 rounded-lg hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 id="player-name" class="text-xl font-bold text-white"></h3>
                            <p id="player-key-display" class="text-sm text-gray-400"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-semibold text-green-400" id="matches-played"></p>
                            <p class="text-sm text-gray-400">Matches Played</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Batting Stats -->
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-yellow-400 mb-3">Batting Statistics</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Total Runs:</span>
                                    <span id="total-runs" class="font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Highest Score:</span>
                                    <span id="highest-score" class="font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Balls Faced:</span>
                                    <span id="total-balls" class="font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Strike Rate:</span>
                                    <span id="strike-rate" class="font-semibold">0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Average:</span>
                                    <span id="batting-average" class="font-semibold">0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bowling Stats -->
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-blue-400 mb-3">Bowling Statistics</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Total Wickets:</span>
                                    <span id="total-wickets" class="font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Best Figures:</span>
                                    <span id="best-bowling" class="font-semibold">0/0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Overs Bowled:</span>
                                    <span id="total-overs" class="font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Runs Conceded:</span>
                                    <span id="runs-conceded" class="font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Economy:</span>
                                    <span id="bowling-economy" class="font-semibold">0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Average:</span>
                                    <span id="bowling-average" class="font-semibold">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <p id="last-updated" class="text-xs text-gray-500"></p>
                    </div>
                </div>

                <div id="player-not-found" class="bg-gray-700 p-6 rounded-lg text-center hidden">
                    <p class="text-lg text-gray-400">Player not found</p>
                    <p class="text-sm text-gray-500 mt-2">No statistics available for this player key.</p>
                </div>

                <button onclick="hideModal('player-stats-modal')" class="w-full mt-6 p-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold">
                    Close
                </button>
            </div>
        </div>

    </div>

    <!-- JavaScript Game Logic -->
    <script>
        // Global game state object
        let gameState = null;
        let matchFinished = false;
        
        const WICKET_DISMISSALS = {
            'Caught': true,
            'Bowled': false,
            'LBW': false,
            'Run Out': true,
            'Stumped': true,
            'Hit Wicket': false,
            'Other': false,
        };

        // --- Game Initialization ---
        function initializeGameState(isLocal) {
            return {
                isLocalMode: isLocal,
                matchSetup: {
                    totalOvers: 20,
                    playersPerTeam: 11,
                    teamAName: 'Team A',
                    teamBName: 'Team B',
                    tossWinner: null,
                    tossChoice: null,
                    battingFirst: null,
                    bowlingFirst: null,
                },
                teams: {
                    A: [],
                    B: [],
                },
                playerKeys: {
                    striker: '',
                    nonStriker: '',
                    bowler: ''
                },
                innings: [],
                currentInningsIndex: -1,
                target: null,
                matchStatus: 'SETUP',
            };
        }

        // --- NEW: Player Key Management ---
        function generateRandomKeys() {
            const strikerKey = 'PLAYER' + Math.random().toString(36).substr(2, 6).toUpperCase();
            const nonStrikerKey = 'PLAYER' + Math.random().toString(36).substr(2, 6).toUpperCase();
            const bowlerKey = 'PLAYER' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            document.getElementById('striker-key').value = strikerKey;
            document.getElementById('non-striker-key').value = nonStrikerKey;
            document.getElementById('bowler-key').value = bowlerKey;
            
            showMessage('Random player keys generated!', 'success');
        }

        // --- Enhanced Roster Setup ---
        function setupRosters() {
            const totalOvers = parseInt(document.getElementById('total-overs').value, 10);
            const playersPerTeam = parseInt(document.getElementById('players-per-team').value, 10);
            
            if (isNaN(totalOvers) || totalOvers <= 0 || isNaN(playersPerTeam) || playersPerTeam < 2 || playersPerTeam > 11) {
                showMessage('Please enter valid overs (min 1) and players (2-11).', 'error');
                return;
            }

            // Initialize game state
            const isLocal = window.db === null;
            gameState = initializeGameState(isLocal);
            gameState.matchSetup.totalOvers = totalOvers;
            gameState.matchSetup.playersPerTeam = playersPerTeam;
            
            // Store player keys (optional)
            gameState.playerKeys.striker = document.getElementById('striker-key').value.trim();
            gameState.playerKeys.nonStriker = document.getElementById('non-striker-key').value.trim();
            gameState.playerKeys.bowler = document.getElementById('bowler-key').value.trim();
            
            // Build roster forms
            const rosterFormsDiv = document.getElementById('roster-forms');
            rosterFormsDiv.innerHTML = '';
            
            ['A', 'B'].forEach(teamKey => {
                let teamName = gameState.matchSetup[`team${teamKey}Name`];
                const formHtml = `
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 text-white">Team ${teamKey} Roster (<input type="text" id="team-${teamKey}-name" value="${teamName}" class="bg-gray-800 p-1 rounded-md text-yellow-300 w-32 inline">)</h3>
                        <div id="roster-team-${teamKey}" class="space-y-2">
                            ${Array(playersPerTeam).fill().map((_, i) => `
                                <div class="flex space-x-2 items-center">
                                    <span class="w-10 text-right text-gray-400">P${i + 1}:</span>
                                    <input type="text" id="p${teamKey}${i + 1}-name" placeholder="Player Name" value="P${teamKey}${i + 1}" class="flex-grow p-2 bg-gray-800 rounded-lg text-sm">
                                    <select type="text" id="p${teamKey}${i + 1}-role" class="p-2 bg-gray-800 rounded-lg text-sm w-32">
                                        <option value="Batsman">Batsman</option>
                                        <option value="Bowler">Bowler</option>
                                        <option value="AllRounder">All Rounder</option>
                                        <option value="WK">Wicket Keeper</option>
                                    </select>
                                    <label class="flex items-center space-x-1">
                                        <input type="radio" name="captain-${teamKey}" value="p${teamKey}${i + 1}" ${i === 0 ? 'checked' : ''} class="form-radio text-indigo-500">
                                        <span class="text-sm text-gray-400">Capt</span>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                rosterFormsDiv.innerHTML += formHtml;
            }); 
            
            hideModal('setup-modal');
            showModal('roster-modal');
        }

        // --- Setup Toss and Start Modal ---
        function setupTossAndStartModal() {
            const playersPerTeam = gameState.matchSetup.playersPerTeam;
            const teamsData = { A: [], B: [] };
            
            ['A', 'B'].forEach(teamKey => {
                const teamName = document.getElementById(`team-${teamKey}-name`).value;
                gameState.matchSetup[`team${teamKey}Name`] = teamName;
                
                for (let i = 0; i < playersPerTeam; i++) {
                    const id = `p${teamKey}${i + 1}`;
                    const name = document.getElementById(`${id}-name`).value;
                    const role = document.getElementById(`${id}-role`).value;
                    const isCaptain = document.querySelector(`input[name="captain-${teamKey}"]:checked`).value === id;
                    
                    teamsData[teamKey].push({
                        id: id,
                        name: name,
                        role: role,
                        isCaptain: isCaptain,
                        runs: 0, balls: 0, fours: 0, sixes: 0, isOut: false,
                        runsGiven: 0, wicketsTaken: 0, ballsBowled: 0, overs: 0,
                    });
                }
            });

            gameState.teams = teamsData;

            // Populate Toss Winner dropdown
            const tossSelect = document.getElementById('toss-winner');
            tossSelect.innerHTML = `
                <option value="A">${gameState.matchSetup.teamAName}</option>
                <option value="B">${gameState.matchSetup.teamBName}</option>
            `;

            hideModal('roster-modal');
            showModal('toss-start-modal');
        }

        function confirmTossAndShowStartingXI() {
            const winnerKey = document.getElementById('toss-winner').value;
            const choice = document.getElementById('toss-choice').value;
            
            gameState.matchSetup.tossWinner = winnerKey;
            gameState.matchSetup.tossChoice = choice;
            
            let battingKey, bowlingKey;

            if ((winnerKey === 'A' && choice === 'bat') || (winnerKey === 'B' && choice === 'bowl')) {
                battingKey = 'A';
                bowlingKey = 'B';
            } else {
                battingKey = 'B';
                bowlingKey = 'A';
            }

            gameState.matchSetup.battingFirst = battingKey;
            gameState.matchSetup.bowlingFirst = bowlingKey;
            
            const battingTeam = gameState.matchSetup[`team${battingKey}Name`];
            
            document.getElementById('batting-team-name-xi').textContent = battingTeam;
            
            populateStartingXISelectors(battingKey, bowlingKey);

            document.getElementById('toss-selection-area').classList.add('hidden');
            document.getElementById('starting-xi-area').classList.remove('hidden');
        }

        function populateStartingXISelectors(battingKey, bowlingKey) {
            const battingRoster = gameState.teams[battingKey];
            const bowlingRoster = gameState.teams[bowlingKey];
            
            const strikerSelect = document.getElementById('start-striker');
            const nonStrikerSelect = document.getElementById('start-non-striker');
            const bowlerSelect = document.getElementById('start-bowler');

            // Populate Batsmen
            const batsmanOptions = battingRoster.map(p => 
                `<option value="${p.id}" ${p.isCaptain ? 'selected' : ''}>${p.name} ${p.isCaptain ? '(C)' : ''}</option>`
            ).join('');
            strikerSelect.innerHTML = batsmanOptions;
            nonStrikerSelect.innerHTML = batsmanOptions;

            // Populate Bowler
            const bowlerOptions = bowlingRoster
                .filter(p => p.role !== 'WK')
                .map(p => 
                    `<option value="${p.id}" ${p.role === 'Bowler' ? 'selected' : ''}>${p.name} ${p.isCaptain ? '(C)' : ''}</option>`
                ).join('');
            bowlerSelect.innerHTML = bowlerOptions;
        }

        // --- Match Start Function ---
        function startMatch() {
            const strikerId = document.getElementById('start-striker').value;
            const nonStrikerId = document.getElementById('start-non-striker').value;
            const bowlerId = document.getElementById('start-bowler').value;

            if (strikerId === nonStrikerId) {
                 showMessage("Striker and Non-Striker must be different players.", 'error');
                 return;
            }

            if (!bowlerId) {
                showMessage("No valid bowler selected. Ensure the bowling team has a non-WK player.", 'error');
                return;
            }

            // Initialize 1st Innings
            const battingKey = gameState.matchSetup.battingFirst;
            const bowlingKey = gameState.matchSetup.bowlingFirst;
            
            gameState.innings.push({
                battingTeamKey: battingKey,
                bowlingTeamKey: bowlingKey,
                runs: 0,
                wickets: 0,
                ballsBowled: 0,
                currentOver: 0,
                extras: { W: 0, NB: 0, B: 0, LB: 0 },
                fallOfWickets: [],
                scorecard: [],
                overLog: [],
                isNewBowlerPending: false,
                
                strikeBatsmanId: strikerId,
                nonStrikeBatsmanId: nonStrikerId,
                currentBowlerId: bowlerId,
                
                playerKeys: {
                    striker: gameState.playerKeys.striker,
                    nonStriker: gameState.playerKeys.nonStriker,
                    bowler: gameState.playerKeys.bowler
                },
                
                nextBatsmanIndex: 0,
            });

            // Mark starting players as used
            const usedPlayerIds = [strikerId, nonStrikerId];
            const nextIndex = gameState.teams[battingKey].findIndex(p => !usedPlayerIds.includes(p.id));
            gameState.innings[0].nextBatsmanIndex = nextIndex !== -1 ? nextIndex : gameState.matchSetup.playersPerTeam;

            gameState.currentInningsIndex = 0;
            gameState.matchStatus = 'IN_PROGRESS';
            matchFinished = false;

            hideModal('toss-start-modal');
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('start-button-container').classList.add('hidden');
            document.getElementById('new-match-btn').classList.add('hidden');
            
            renderGame();
            if (window.currentUser && window.currentUser.uid) {
                window.saveGame(window.currentUser.uid);
            }
        }

        // --- Core Game Functions ---
        function getCurrentInnings() {
            return gameState.innings[gameState.currentInningsIndex];
        }

        function getPlayer(id) {
            const teamKey = id.charAt(1);
            const teamRoster = gameState.teams[teamKey];
            return teamRoster ? teamRoster.find(p => p.id === id) : null;
        }

        function getBatsman(isStrike) {
            const innings = getCurrentInnings();
            if (!innings) return null;
            const id = isStrike ? innings.strikeBatsmanId : innings.nonStrikeBatsmanId;
            return getPlayer(id);
        }

        function getBowler() {
            const innings = getCurrentInnings();
            if (!innings) return null;
            return getPlayer(innings.currentBowlerId);
        }

        // --- FIXED: Score Display and Over Log ---
        function renderGame() {
            if (!gameState || gameState.matchStatus === 'SETUP' || gameState.currentInningsIndex === -1) {
                document.getElementById('game-view').classList.add('hidden');
                document.getElementById('start-button-container').classList.remove('hidden');
                return;
            }

            const innings = getCurrentInnings();
            if (!innings) return;

            const strikeBatsman = getBatsman(true);
            const nonStrikeBatsman = getBatsman(false);
            const bowler = getBowler();
            const battingTeamName = gameState.matchSetup[`team${innings.battingTeamKey}Name`];
            const target = gameState.target || 0;
            
            // Update score display
            document.getElementById('battingTeamName').textContent = battingTeamName;
            document.getElementById('targetDisplay').textContent = target > 0 ? target : 'N/A';
            document.getElementById('totalRuns').textContent = innings.runs;
            document.getElementById('totalWickets').textContent = innings.wickets;
            document.getElementById('currentOvers').textContent = `${innings.currentOver}.${innings.ballsBowled}`;
            
            // FIXED: Over log display
            document.getElementById('over-log-display').textContent = innings.overLog.length > 0 ? innings.overLog.join(' ') : '--';

            // Update batsmen
            document.getElementById('strikeBatsman').textContent = strikeBatsman ? strikeBatsman.name + ' *' : 'N/A';
            document.getElementById('strikeRuns').textContent = strikeBatsman ? strikeBatsman.runs : 0;
            document.getElementById('strikeBalls').textContent = strikeBatsman ? strikeBatsman.balls : 0;

            document.getElementById('nonStrikeBatsman').textContent = nonStrikeBatsman ? nonStrikeBatsman.name : 'N/A';
            document.getElementById('nonStrikeRuns').textContent = nonStrikeBatsman ? nonStrikeBatsman.runs : 0;
            document.getElementById('nonStrikeBalls').textContent = nonStrikeBatsman ? nonStrikeBatsman.balls : 0;

            // Update bowler
            document.getElementById('currentBowler').textContent = bowler ? bowler.name : 'N/A';
            document.getElementById('bowlerRuns').textContent = bowler ? bowler.runsGiven : 0;
            document.getElementById('bowlerWickets').textContent = bowler ? bowler.wicketsTaken : 0;
            
            // Bowler selection
            const bowlerContainer = document.getElementById('newBowlerContainer');
            if (innings.isNewBowlerPending && !matchFinished) {
                populateBowlerSelect();
                bowlerContainer.classList.remove('hidden');
                document.querySelectorAll('.action-button').forEach(btn => btn.disabled = true);
            } else {
                bowlerContainer.classList.add('hidden');
                document.querySelectorAll('.action-button').forEach(btn => btn.disabled = matchFinished);
            }
            
            // Innings button
            const newInningsBtn = document.getElementById('start-new-innings-btn');
            if (gameState.currentInningsIndex === 0 && matchFinished) {
                newInningsBtn.classList.remove('hidden');
            } else {
                newInningsBtn.classList.add('hidden');
            }
            
            // New match button
            const newMatchBtn = document.getElementById('new-match-btn');
            if (gameState.matchStatus === 'FINISHED') {
                newMatchBtn.classList.remove('hidden');
            } else {
                newMatchBtn.classList.add('hidden');
            }
        }

        function handleRunAction(runs, actionText) {
            if (matchFinished || isOverBlocked()) return;

            const innings = getCurrentInnings();
            const strikeBatsman = getBatsman(true);
            const bowler = getBowler();

            if (!strikeBatsman || !bowler) return;

            // Update scores
            innings.runs += runs;
            strikeBatsman.runs += runs;
            strikeBatsman.balls++;
            if (runs === 4) strikeBatsman.fours++;
            if (runs === 6) strikeBatsman.sixes++;
            bowler.runsGiven += runs;

            // Log ball - FIXED: Proper ball logging
            innings.overLog.push(runs.toString());
            updateBallCount(false);

            // Swap strike for odd runs
            if (runs % 2 !== 0 && innings.ballsBowled !== 0) {
                swapStrike();
            }
            
            showMessage(actionText + ` - ${runs} run(s). Total: ${innings.runs}/${innings.wickets}`, 'success');
            renderGame();
            if (window.currentUser && window.currentUser.uid) {
                window.saveGame(window.currentUser.uid);
            }
            
            checkMatchEnd();
        }

        function handleExtraAction(type, runs) {
            if (matchFinished || isOverBlocked()) return;

            const innings = getCurrentInnings();
            const bowler = getBowler();
            if (!bowler) return;

            const runsToScore = runs;
            innings.runs += runsToScore;
            innings.extras[type.split('-')[0].charAt(0)] += runsToScore;
            
            let symbol = '';
            let strikeSwapNeeded = false;

            if (type === 'Wide' || type === 'No-Ball') {
                bowler.runsGiven += runsToScore;
                symbol = (type === 'Wide' ? 'WD' : 'NB') + (runsToScore > 1 ? `+${runsToScore - 1}` : '');
                strikeSwapNeeded = (runsToScore % 2 !== 0);
            } else {
                getBatsman(true).balls++;
                symbol = (type.charAt(0)) + (runsToScore > 0 ? runsToScore : '');
                updateBallCount(false);
                strikeSwapNeeded = (runsToScore % 2 !== 0);
            }
            
            innings.overLog.push(symbol);
            if (strikeSwapNeeded) swapStrike();

            showMessage(`${type} declared. Total: ${innings.runs}/${innings.wickets}.`, 'warning');
            renderGame();
            if (window.currentUser && window.currentUser.uid) {
                window.saveGame(window.currentUser.uid);
            }
            checkMatchEnd();
        }

        // --- FIXED: Wicket Functions with Next Batsman Selection ---
        function prepareWicketModal() {
            if (matchFinished || isOverBlocked()) return;

            const innings = getCurrentInnings();
            const strikeBatsman = getBatsman(true);
            const bowler = getBowler();

            if (!strikeBatsman || !bowler) return;

            // Check if all batsmen are out
            const availableBatsmen = gameState.teams[innings.battingTeamKey].filter(player => 
                !player.isOut && 
                player.id !== innings.strikeBatsmanId && 
                player.id !== innings.nonStrikeBatsmanId
            );

            // If no batsmen left, end innings immediately
            if (availableBatsmen.length === 0) {
                innings.wickets++;
                strikeBatsman.balls++;
                strikeBatsman.isOut = true;
                
                // Record fall of wicket
                innings.fallOfWickets.push({
                    batsmanName: strikeBatsman.name,
                    runs: strikeBatsman.runs,
                    balls: strikeBatsman.balls,
                    bowlerName: bowler.name,
                    dismissal: 'All Out',
                    fielderName: null,
                    score: `${innings.runs}-${innings.wickets}`,
                    over: `${innings.currentOver}.${innings.ballsBowled}`,
                });

                updateBallCount(false);
                showMessage(`ALL OUT! ${strikeBatsman.name} is OUT. Innings completed!`, 'error');
                endInnings();
                return;
            }

            // Set batsman name
            document.getElementById('batsman-out-name').textContent = strikeBatsman.name;
            document.getElementById('wicket-bowler-name').textContent = bowler.name;

            // Populate fielder select
            const bowlingRoster = gameState.teams[innings.bowlingTeamKey];
            const fielderSelect = document.getElementById('fielder-select');
            fielderSelect.innerHTML = `<option value="">-- No Fielder Credited --</option>`;

            bowlingRoster.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} ${p.role === 'WK' ? '(WK)' : ''}`;
                fielderSelect.appendChild(option);
            });

            // FIXED: Populate next batsman select
            const nextBatsmanSelect = document.getElementById('next-batsman-select');
            nextBatsmanSelect.innerHTML = '';
            
            availableBatsmen.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = `${player.name} ${player.isCaptain ? '(C)' : ''}`;
                nextBatsmanSelect.appendChild(option);
            });

            // Set default dismissal type
            document.getElementById('dismissal-type').value = 'Caught';
            toggleFielder('Caught');
            
            showModal('wicket-modal');
        }

        function toggleFielder(dismissalType) {
            const fielderGroup = document.getElementById('fielder-group');
            const nextBatsmanGroup = document.getElementById('next-batsman-group');
            
            if (WICKET_DISMISSALS[dismissalType]) {
                fielderGroup.classList.remove('hidden');
            } else {
                fielderGroup.classList.add('hidden');
            }
            
            // Always show next batsman selection
            if (nextBatsmanGroup) {
                nextBatsmanGroup.classList.remove('hidden');
            }
        }

        // FIXED: Wicket handling with user-selected next batsman
        function handleWicketActionFromModal() {
            const dismissalType = document.getElementById('dismissal-type').value;
            const fielderId = document.getElementById('fielder-select').value || null;
            const nextBatsmanId = document.getElementById('next-batsman-select').value;
            
            // Validation
            if (WICKET_DISMISSALS[dismissalType] && !fielderId) {
                showMessage(`Fielder/Keeper must be selected for ${dismissalType}.`, 'error');
                return;
            }

            if (!nextBatsmanId) {
                showMessage('Please select the next batsman.', 'error');
                return;
            }

            const innings = getCurrentInnings();
            const strikeBatsman = getBatsman(true);
            const bowler = getBowler();

            // Update wicket count
            innings.wickets++;
            strikeBatsman.balls++;
            strikeBatsman.isOut = true;

            // Credit bowler for appropriate dismissals
            if (['Caught', 'Bowled', 'LBW', 'Stumped'].includes(dismissalType)) {
                bowler.wicketsTaken++;
            }

            // Log wicket
            let symbol = 'W';
            if (dismissalType === 'Run Out') symbol = 'R.O';
            if (dismissalType === 'Stumped') symbol = 'ST';
            innings.overLog.push(symbol);

            // Record fall of wicket
            const fielder = fielderId ? getPlayer(fielderId) : null;
            innings.fallOfWickets.push({
                batsmanName: strikeBatsman.name,
                runs: strikeBatsman.runs,
                balls: strikeBatsman.balls,
                bowlerName: bowler.name,
                dismissal: dismissalType,
                fielderName: fielder ? fielder.name : null,
                score: `${innings.runs}-${innings.wickets}`,
                over: `${innings.currentOver}.${innings.ballsBowled}`,
            });

            // FIXED: Set next batsman based on user selection
            innings.strikeBatsmanId = nextBatsmanId;
            
            // Update next batsman index
            const battingRoster = gameState.teams[innings.battingTeamKey];
            innings.nextBatsmanIndex = Math.max(innings.nextBatsmanIndex, 
                battingRoster.findIndex(p => p.id === nextBatsmanId) + 1);

            updateBallCount(false);

            showMessage(`Wicket! ${strikeBatsman.name} is OUT, ${dismissalType}. New batsman: ${getPlayer(nextBatsmanId).name}`, 'error');
            hideModal('wicket-modal');
            renderGame();
            if (window.currentUser && window.currentUser.uid) {
                window.saveGame(window.currentUser.uid);
            }
            
            checkMatchEnd();
        }

        // FIXED: Added showScorecard function
        function showScorecard() {
            if (!gameState || gameState.innings.length === 0) {
                showMessage('No match data available to display scorecard.', 'warning');
                return;
            }

            const scorecardContent = document.getElementById('scorecard-content');
            scorecardContent.innerHTML = '';

            gameState.innings.forEach((innings, index) => {
                const inningsNumber = index + 1;
                const battingTeamName = gameState.matchSetup[`team${innings.battingTeamKey}Name`];
                const bowlingTeamName = gameState.matchSetup[`team${innings.bowlingTeamKey}Name`];
                
                const inningsHtml = `
                    <div class="bg-gray-700 p-4 rounded-lg mb-6">
                        <h3 class="text-xl font-bold text-yellow-300 mb-4">Innings ${inningsNumber}: ${battingTeamName} vs ${bowlingTeamName}</h3>
                        
                        <!-- Team Score Summary -->
                        <div class="mb-4 p-3 bg-gray-800 rounded-lg">
                            <p class="text-lg font-semibold">${innings.runs}/${innings.wickets} in ${innings.currentOver}.${innings.ballsBowled} overs</p>
                            <p class="text-sm text-gray-400">Extras: W-${innings.extras.W} NB-${innings.extras.NB} B-${innings.extras.B} LB-${innings.extras.LB}</p>
                        </div>

                        <!-- Batting Scorecard -->
                        <h4 class="text-lg font-semibold text-green-400 mb-2">Batting</h4>
                        <div class="overflow-x-auto">
                            <table class="scorecard-table">
                                <thead>
                                    <tr>
                                        <th>Batsman</th>
                                        <th>R</th>
                                        <th>B</th>
                                        <th>4s</th>
                                        <th>6s</th>
                                        <th>SR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${gameState.teams[innings.battingTeamKey].map(player => {
                                        const isOut = player.isOut || false;
                                        const strikeRate = player.balls > 0 ? ((player.runs / player.balls) * 100).toFixed(2) : '0.00';
                                        return `
                                            <tr class="${player.id === innings.strikeBatsmanId ? 'bg-indigo-900' : ''}">
                                                <td class="font-medium">
                                                    ${player.name} ${player.isCaptain ? '(C)' : ''}
                                                    ${isOut ? '' : (player.id === innings.strikeBatsmanId || player.id === innings.nonStrikeBatsmanId ? '*' : '')}
                                                </td>
                                                <td>${player.runs}</td>
                                                <td>${player.balls}</td>
                                                <td>${player.fours || 0}</td>
                                                <td>${player.sixes || 0}</td>
                                                <td>${strikeRate}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Bowling Scorecard -->
                        <h4 class="text-lg font-semibold text-blue-400 mt-4 mb-2">Bowling</h4>
                        <div class="overflow-x-auto">
                            <table class="scorecard-table">
                                <thead>
                                    <tr>
                                        <th>Bowler</th>
                                        <th>O</th>
                                        <th>M</th>
                                        <th>R</th>
                                        <th>W</th>
                                        <th>ECO</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${gameState.teams[innings.bowlingTeamKey]
                                        .filter(player => player.ballsBowled > 0)
                                        .map(player => {
                                            const overs = `${Math.floor(player.ballsBowled / 6)}.${player.ballsBowled % 6}`;
                                            const economy = player.ballsBowled > 0 ? 
                                                ((player.runsGiven / player.ballsBowled) * 6).toFixed(2) : '0.00';
                                            return `
                                                <tr class="${player.id === innings.currentBowlerId ? 'bg-indigo-900' : ''}">
                                                    <td class="font-medium">${player.name} ${player.isCaptain ? '(C)' : ''}</td>
                                                    <td>${overs}</td>
                                                    <td>0</td>
                                                    <td>${player.runsGiven}</td>
                                                    <td>${player.wicketsTaken}</td>
                                                    <td>${economy}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Fall of Wickets -->
                        ${innings.fallOfWickets.length > 0 ? `
                            <h4 class="text-lg font-semibold text-red-400 mt-4 mb-2">Fall of Wickets</h4>
                            <div class="bg-gray-800 p-3 rounded-lg">
                                ${innings.fallOfWickets.map(wicket => `
                                    <p class="text-sm mb-1">
                                        ${wicket.score} - ${wicket.batsmanName} ${wicket.runs} (${wicket.balls}b) 
                                        ${wicket.dismissal} ${wicket.fielderName ? `c ${wicket.fielderName}` : ''} 
                                        b ${wicket.bowlerName} (${wicket.over})
                                    </p>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                scorecardContent.innerHTML += inningsHtml;
            });

            showModal('scorecard-modal');
        }

        function updateBallCount(isExtra = false) {
            const innings = getCurrentInnings();
            const bowler = getBowler();
            
            if (!bowler) return;

            if (!isExtra) {
                innings.ballsBowled++;
                bowler.ballsBowled++;
            }

            if (innings.ballsBowled === 6) {
                innings.ballsBowled = 0;
                innings.currentOver++;
                bowler.overs++;
                swapStrike();
                
                innings.isNewBowlerPending = true;
                
                if (checkMatchEnd()) {
                    endInnings();
                    return;
                }
                
                showMessage(`Over ${innings.currentOver} completed! Please select a new bowler.`, 'info');
            }
        }

        function swapStrike() {
            const innings = getCurrentInnings();
            if (innings.isNewBowlerPending && !matchFinished) {
                 showMessage("Please select a new bowler and click 'Start Over' before swapping strike.", 'warning');
                 return;
            }
            
            [innings.strikeBatsmanId, innings.nonStrikeBatsmanId] = [innings.nonStrikeBatsmanId, innings.strikeBatsmanId];
            showMessage('Strike swapped!', 'info');
            renderGame();
            if (window.currentUser && window.currentUser.uid) {
                window.saveGame(window.currentUser.uid);
            }
        }

        function isOverBlocked() {
            const innings = getCurrentInnings();
            if (innings.isNewBowlerPending) {
                 showMessage("Please select a new bowler and click 'Start Over' before scoring.", 'warning');
                 return true;
            }
            return false;
        }

        function checkMatchEnd() {
            const innings = getCurrentInnings();
            const setup = gameState.matchSetup;

            // Check if all wickets are gone (playersPerTeam - 1 because 11 players means 10 wickets)
            if (innings.wickets >= setup.playersPerTeam - 1) {
                innings.isAllOut = true;
                endInnings();
                return true;
            }

            if (innings.currentOver >= setup.totalOvers) {
                endInnings();
                return true;
            }
            
            if (gameState.currentInningsIndex === 1 && gameState.target !== null && innings.runs >= gameState.target) {
                endInnings();
                return true;
            }

            return false;
        }

        function populateBowlerSelect() {
            const innings = getCurrentInnings();
            const select = document.getElementById('bowlerSelect');
            const currentBowlerId = innings.currentBowlerId;
            const bowlingRoster = gameState.teams[innings.bowlingTeamKey];

            const availableBowlers = bowlingRoster.filter(p => 
                p.role !== 'WK' && p.id !== currentBowlerId
            );

            select.innerHTML = '<option value="" disabled selected>-- Choose Bowler --</option>';

            availableBowlers.forEach(player => {
                const playerStats = getPlayer(player.id);
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = `${player.name} (${playerStats.overs}.${playerStats.ballsBowled % 6} ov, ${playerStats.runsGiven}/${playerStats.wicketsTaken})`; 
                select.appendChild(option);
            });
        }

        function startNewOver() {
            const select = document.getElementById('bowlerSelect');
            const newBowlerId = select.value;
            const innings = getCurrentInnings();
            
            if (!newBowlerId) {
                showMessage("Please select a bowler to start the new over.", 'warning');
                return;
            }

            const newBowler = getPlayer(newBowlerId);
            innings.currentBowlerId = newBowlerId;
            innings.isNewBowlerPending = false;
            innings.overLog = [];
            
            showMessage(`New over started! Bowler is now ${newBowler.name}.`, 'success');
            renderGame();
            if (window.currentUser && window.currentUser.uid) {
                window.saveGame(window.currentUser.uid);
            }
        }

        async function endInnings() {
            matchFinished = true;
            const innings = getCurrentInnings();
            const matchSetup = gameState.matchSetup;

            document.querySelectorAll('.action-button').forEach(btn => btn.disabled = true);
            document.getElementById('newBowlerContainer').classList.add('hidden');
            
            innings.overLog.push('END');

            if (gameState.currentInningsIndex === 0) {
                gameState.target = innings.runs + 1;
                showMessage(`Innings 1 finished! Target for ${matchSetup[`team${innings.bowlingTeamKey}Name`]} is ${gameState.target}.`, 'warning');
                document.getElementById('start-new-innings-btn').classList.remove('hidden');
                document.getElementById('battingTeamName').textContent = `${matchSetup[`team${innings.bowlingTeamKey}Name`]}`;
            } else {
                gameState.matchStatus = 'FINISHED';
                
                const targetToWin = gameState.target;
                const runsScored = innings.runs;
                const runsNeeded = targetToWin - runsScored;

                let resultMessage;
                if (runsScored >= targetToWin) {
                    const remainingWickets = matchSetup.playersPerTeam - 1 - innings.wickets;
                    resultMessage = `${matchSetup[`team${innings.battingTeamKey}Name`]} won by ${remainingWickets} wickets!`;
                } else if (runsNeeded === 1) {
                     resultMessage = `Match Tied!`;
                } else {
                     const runsDifference = runsNeeded - 1;
                     resultMessage = `${matchSetup[`team${innings.bowlingTeamKey}Name`]} won by ${runsDifference} runs!`;
                }
                showMessage(`Match Finished! ${resultMessage}`, 'success');
                document.getElementById('new-match-btn').classList.remove('hidden');
            }

            renderGame();
            if (window.currentUser && window.currentUser.uid) {
                window.saveGame(window.currentUser.uid);
            }
        }

        function startNewInnings() {
            const currentInnings = getCurrentInnings();
            const battingKey = currentInnings.bowlingTeamKey;
            const bowlingKey = currentInnings.battingTeamKey;
            const battingRoster = gameState.teams[battingKey];
            
            const firstBowler = gameState.teams[bowlingKey].find(p => p.role !== 'WK');
            
            if (!firstBowler) {
                showMessage("Error: Cannot start second innings. Bowling team has no non-WK players.", 'error');
                return;
            }

            // Initialize 2nd Innings
            gameState.innings.push({
                battingTeamKey: battingKey,
                bowlingTeamKey: bowlingKey,
                runs: 0,
                wickets: 0,
                ballsBowled: 0,
                currentOver: 0,
                extras: { W: 0, NB: 0, B: 0, LB: 0 },
                fallOfWickets: [],
                scorecard: [],
                overLog: [],
                isNewBowlerPending: false,
                
                strikeBatsmanId: battingRoster[0].id,
                nonStrikeBatsmanId: battingRoster[1].id,
                currentBowlerId: firstBowler.id,
                
                playerKeys: {
                    striker: '',
                    nonStriker: '',
                    bowler: ''
                },
                
                nextBatsmanIndex: 2,
            });

            gameState.currentInningsIndex = 1;
            matchFinished = false;

            document.querySelectorAll('.action-button').forEach(btn => btn.disabled = false);
            document.getElementById('start-new-innings-btn').classList.add('hidden');

            renderGame();
            if (window.currentUser && window.currentUser.uid) {
                window.saveGame(window.currentUser.uid);
            }
        }

        function startNewMatch() {
            const isLocal = gameState ? gameState.isLocalMode : (window.db === null);
            gameState = initializeGameState(isLocal);
            gameState.matchStatus = 'SETUP';
            matchFinished = false;
            
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('start-button-container').classList.remove('hidden');
            document.getElementById('new-match-btn').classList.add('hidden');
            
            document.querySelectorAll('.action-button').forEach(btn => btn.disabled = false);
            
            showModal('setup-modal');
            document.getElementById('scorecard-content').innerHTML = '';
            
            showMessage('New match setup ready! Configure your match settings.', 'success');
            
            if (window.db && window.currentUser) {
                window.saveGame(window.currentUser.uid);
            }
        }

        // --- NEW: Player Stats Loading ---
        async function loadPlayerStats() {
            const playerKey = document.getElementById('player-key-input').value.trim();
            
            if (!playerKey) {
                showMessage('Please enter a player key.', 'error');
                return;
            }

            const stats = await window.getPlayerStats(playerKey);
            
            if (stats) {
                displayPlayerStats(stats);
            } else {
                document.getElementById('player-stats-content').classList.add('hidden');
                document.getElementById('player-not-found').classList.remove('hidden');
            }
        }

        function displayPlayerStats(stats) {
            document.getElementById('player-not-found').classList.add('hidden');
            document.getElementById('player-stats-content').classList.remove('hidden');
            
            // Basic info
            document.getElementById('player-name').textContent = stats.name || 'Unknown Player';
            document.getElementById('player-key-display').textContent = `Key: ${stats.playerKey}`;
            document.getElementById('matches-played').textContent = stats.matchesPlayed || 0;
            
            // Batting stats
            document.getElementById('total-runs').textContent = stats.totalRuns || 0;
            document.getElementById('highest-score').textContent = stats.highestScore || 0;
            document.getElementById('total-balls').textContent = stats.totalBallsFaced || 0;
            
            const strikeRate = stats.totalBallsFaced > 0 ? ((stats.totalRuns / stats.totalBallsFaced) * 100).toFixed(2) : '0.00';
            document.getElementById('strike-rate').textContent = strikeRate;
            
            const battingAverage = stats.matchesPlayed > 0 ? (stats.totalRuns / stats.matchesPlayed).toFixed(2) : '0.00';
            document.getElementById('batting-average').textContent = battingAverage;
            
            // Bowling stats
            document.getElementById('total-wickets').textContent = stats.totalWickets || 0;
            document.getElementById('best-bowling').textContent = `${stats.bestBowlingWickets || 0}/${stats.bestBowlingRuns || 0}`;
            document.getElementById('total-overs').textContent = stats.totalOversBowled ? stats.totalOversBowled.toFixed(1) : '0';
            document.getElementById('runs-conceded').textContent = stats.totalRunsConceded || 0;
            
            const economy = stats.totalOversBowled > 0 ? (stats.totalRunsConceded / stats.totalOversBowled).toFixed(2) : '0.00';
            document.getElementById('bowling-economy').textContent = economy;
            
            const bowlingAverage = stats.totalWickets > 0 ? (stats.totalRunsConceded / stats.totalWickets).toFixed(2) : '0.00';
            document.getElementById('bowling-average').textContent = bowlingAverage;
            
            // Last updated
            if (stats.lastUpdated) {
                const lastUpdated = new Date(stats.lastUpdated).toLocaleString();
                document.getElementById('last-updated').textContent = `Last updated: ${lastUpdated}`;
            }
        }

        // --- Utility Functions ---
        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('flex');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('flex');
            document.getElementById(id).classList.add('hidden');
        }

        function showMessage(message, type = 'info') {
            const box = document.getElementById('messageBox');
            const text = document.getElementById('messageText');
            
            box.className = 'fixed top-4 left-1/2 -translate-x-1/2 p-4 rounded-lg z-50 text-center shadow-2xl min-w-[300px]';

            switch (type) {
                case 'success':
                    box.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    box.classList.add('bg-red-500', 'text-white');
                    break;
                case 'warning':
                    box.classList.add('bg-yellow-500', 'text-gray-900');
                    break;
                case 'info':
                default:
                    box.classList.add('bg-blue-500', 'text-white');
                    break;
            }

            text.textContent = message;
            box.classList.add('show');

            setTimeout(() => {
                box.classList.remove('show');
            }, 3000);
        }

        function promptRuns() {
            const runsInput = prompt("Enter runs for the extra (e.g., 2 or 4):");
            const runs = parseInt(runsInput);
            if (isNaN(runs) || runs < 0) {
                 showMessage('Invalid input. Defaulting to 1 run.', 'error');
                 return 1;
            }
            return runs;
        }

        // --- Final Startup Call ---
        window.onload = function() {
            if (typeof window.initAuthAndFirestore === 'function') {
                window.initAuthAndFirestore();
            } else {
                console.error("Firebase init function not found. Running local-only mode.");
                window.currentUser = { uid: crypto.randomUUID() };
                document.getElementById('userIdDisplay').textContent = window.currentUser.uid + " (Local)";
                gameState = initializeGameState(true);
                renderGame();
            }
        };

    </script>
</body>
</html>